# 分布式系统的一些基本概念 #
## cap原则 ##
cap：指的是在一个分布式系统中，**consistency**（一致性）、**availability** （可用性）和 **tolerance** （分区容错性），三者不可兼得。

![cap](https://raw.githubusercontent.com/ernest-dzf/docs/master/pic/cap.png)

- **一致性**（C）：在分布式系统中的所有数据备份，在同一时刻是否是同样的值。
- **可用性**（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）
- **分区容错性**（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。

CAP理论就是说在分布式存储系统中，最多只能实现上面的两点。**而由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性是我们必须需要实现的**。所以我们只能在一致性和可用性之间进行权衡，没有NoSQL系统能同时保证这三点。

举个例子，mysql是CA，mongo是CP。

对于一个分布式系统，我们始终要假设网络是不可靠的，所以**分区容错性**是对一个分布式系统最基本的要求，所以我们更多的是尝试在**可用性**和**一致性**之间寻找一个平衡点。



## 分布式事务 ##

在说分布式事务之前，先说一下数据库的事务。

### 数据库事务 ###

很多人都知道数据库事务的几个特性：原子性(Atomicity)、一致性(Consistency)、隔离性或独立性(Isolation)和持久性(Durabilily)，简称就是ACID。

我们先来想想，假如数据库在提交事务的时候突然断电，那么它是怎么样恢复的呢？

以mysql支持事务的 innodb 存储引擎为例，这里有redo log 和undo log。

undo log 记录某数据被修改前的值，可以用来在事务失败时进行rollback；redo log 记录某数据块被修改后的值，可以用来恢复未写入data file的已成功事务更新的数据。


数据库进行任何写入操作的时候都是要先写日志，把日志文件写入磁盘，那么当突然断电，即使操作没有完成，在重新启动数据库时候，数据库会根据当前数据的情况进行undo回滚或者是redo前滚，这样就保证了数据的强一致性。

## 两阶段提交协议（two phase commit protocol，2PC） ##

在两阶段提交协议中，系统一般包含两类机器（或节点）：一类为**协调者**（coordinator），通常一个系统中只有一个；另一类为**事务参与者**（participants，cohorts或workers），一般包含多个，在数据存储系统中可以理解为数据副本的个数。

