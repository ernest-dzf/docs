# 分布式锁

## 场景

你只有1台机器部署服务的话，不需要用到分布式锁。

但是对于100台、1000台机器，去承担用户请求，所有机器需要用锁进行协同的话，那么就需要分布式锁。

## 实现方式

### redis

通过在redis设置1个key，设置成功就上锁，处理完毕将这个key删除就释放锁。

#### 问题

如果上锁之后，挂掉了，就没人能删除这个key了，导致其他用户无法上锁。

#### 处理方法

1. **设置key的有效期**，超过这个时间key自动删除。redis支持这个特性。这也就是将key的删除交给redis。
   可能有人会使用`setnx`配合`expire`来实现，但是这2个非原子，可能`setnx`执行之后就挂了，导致key可能一直不被删除。
   redis最新版本支持了通过在SET命令加一些option来实现，就是原子的了。可以参考，https://redis.io/commands/set。

2. **将删除key的动作交给其他应用**。比如应用在设置key的时候，value为超时时间点。其他应用在设置key失败的时候，会去查当前时间是否大于这个key的超时时间，如果大于，就将这个key删除。
   但是有个**问题**是，不光你服务器2可能会发现服务器1超时了，服务器3也可能会发现，如果刚好服务器2 setnx操作完成，服务器3就接着删除，是不是服务器3也可以setnx成功了？
   如何解决呢？
   可以使用redis的`GETSET`命令。

   ```shell
   redis 127.0.0.1:6379> GETSET KEY_NAME VALUE
   ```

   用于设置指定 key 的值，并返回 key 的旧值。
   假设服务器2发现key过期了，开始调用getset命令，然后用获取的时间判断是否过期，如果获取的时间仍然是过期的，那就说明拿到锁了。

   如果没有，则说明在服务2执行getset之前，服务器3可能也发现锁过期了，并且在服务器2之前执行了getset操作，重新设置了过期时间。

   那么服务器2就需要放弃后续的操作，继续等待服务器3释放锁或者去监测key的有效期是否过期。

   这块其实有一个小问题是，服务器3已经修改了有效期，拿到锁之后，服务器2也修改了有效期，但是没能拿到锁，但是这个有效期的时间已经被在服务器3的基础上有增加一些，但是这种影响其实还是很小的，几乎可以忽略不计。

参考:

1. http://zhangtielei.com/posts/blog-redlock-reasoning.html
2. https://mp.weixin.qq.com/s/2P2-ujcdet9cUycokfyjHQ

### zookeeper

可以使用zk实现分布式锁。

下面我们继续结合我们上面的分红包场景，描述下在Zookeeper中如何加锁。

假设服务器1，创建了一个节点 /zkjjj，成功了，那服务器1就获取了锁，服务器2再去创建相同的锁，就会失败，这个时候就只能监听这个节点的变化。

等到服务器1处理完业务，删除了节点后，他就会得到通知，然后去创建同样的节点，获取锁处理业务，再删除节点，后续的100台服务器与之类似。

注意这里的100台服务器并不是挨个去执行上面的创建节点的操作，而是并发的，当服务器1创建成功，那么剩下的99个就都会注册监听这个节点，等通知，以此类推。

但是大家有没有注意到，这里还是有问题的，还是会有死锁的情况存在，对不对？

当服务器1创建了节点后挂了，没能删除，那其他99台服务器就会一直等通知，那就完蛋了。。。

这个时候就需要用到临时性节点了，我们前面说过了，临时性节点的特点是客户端一旦断开，就会丢失，也就是当服务器1创建了节点后，如果挂了，那这个节点会自动被删除，这样后续的其他服务器，就可以继续去创建节点，获取锁了。

但是我们可能还需要注意到一点，就是惊群效应：举一个很简单的例子，当你往一群鸽子中间扔一块食物，虽然最终只有一个鸽子抢到食物，但所有鸽子都会被惊动来争夺，没有抢到…

就是当服务器1节点有变化，会通知其余的99个服务器，但是最终只有1个服务器会创建成功，这样98还是需要等待监听，那么为了处理这种情况，就需要用到临时顺序性节点。大致意思就是，之前是所有99个服务器都监听一个节点，现在就是每一个服务器监听自己前面的一个节点。

假设100个服务器同时发来请求，这个时候会在/zkjjj节点下创建100个临时顺序性节点/zkjjj/000000001，/zkjjj/000000002，一直到/zkjjj/000000100，这个编号就等于是已经给他们设置了获取锁的先后顺序了。

当001节点处理完毕，删除节点后，002收到通知，去获取锁，开始执行，执行完毕，删除节点，通知003~以此类推。

## 特殊case

如果业务执行时间确实由于其他原因，大于超时时间改如何处理？

可以类似看门狗，不断给锁续期。



## 参考

https://zhuanlan.zhihu.com/p/72896771